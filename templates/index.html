<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Character Generator</title>

  <!-- âœ… Load TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- âœ… Load Montserrat font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    /* âœ… Set Montserrat font and background gradient */
    body {
      font-family: 'Montserrat', sans-serif;
      background: radial-gradient(circle at top, #002d08, #c1ffc0);
    }

    /* âœ… Fade-in animation for image and description */
    .fade-in {
      animation: fadeIn 0.8s ease-in-out forwards;
      opacity: 0;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center px-4 py-6 bg-black-50 text-black-800">

  <div class="w-full max-w-md sm:max-w-xl">
    <!-- âœ… Main title -->
    <h1 class="text-4xl font-bold text-center text-white mb-4">ðŸŽ§ Your Spotify Avatar ðŸŽ§</h1>

    <!-- âœ… Subtitle -->
    <p class="text-center text-md mb-6 text-white">Personify your spotify</p>    

    <!-- âœ… Character Image Container -->
    <div id="characterImage" class="rounded-2xl overflow-hidden shadow-xl mb-6 bg-white aspect-square flex items-center justify-center relative">

      <!-- âœ… Spinner overlay shown while image is loading -->
      <div id="spinner" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
        <svg class="animate-spin h-10 w-10 text-pink-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <p class="text-sm text-pink-600 font-medium">This could take a few minutes...</p>
      </div>

      <!-- âœ… Image of generated character -->
      <img id="image" src="" alt="Character portrait" class="w-full h-full object-cover hidden" />
    </div>

    <!-- âœ… Description box -->
    <div id="description" class="bg-white rounded-xl shadow-md p-6 text-base sm:text-lg font-medium leading-relaxed text-gray-800 fade-in">
      Loading your inner music persona...
    </div>

    <!-- âœ… "Generate Again" button -->
    <button
      onclick="fetchCharacter()"
      class="mt-6 w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition">
      ðŸ”„ Generate Again
    </button>
  </div>

  <!-- âœ… Script section -->
  <script>
    let ellipsisInterval = null;

    /**
     * Starts animated ellipsis in the description.
     */
    function startEllipsisAnimation(baseText) {
      const descEl = document.getElementById("description");
      let dotCount = 0;
      ellipsisInterval = setInterval(() => {
        dotCount = (dotCount + 1) % 8; // cycle from 0 to 7 dots
        let dots = ".".repeat(dotCount) + " ".repeat(7 - dotCount);
        descEl.textContent = baseText + " " + dots;
      }, 300);
    }

    /**
     * Stops the animated ellipsis.
     */
    function stopEllipsisAnimation() {
      clearInterval(ellipsisInterval);
      ellipsisInterval = null;
    }

    /**
     * Fetch character data from backend and update UI
     */
    async function fetchCharacter() {
      const baseLoadingText = "Tuning into your inner music persona";
      const descEl = document.getElementById("description");
      const imageElement = document.getElementById("image");
      const spinner = document.getElementById("spinner");

      // Reset UI state
      imageElement.classList.add("hidden");
      spinner.style.display = "flex";
      imageElement.src = "";
      startEllipsisAnimation(baseLoadingText);

      // Fetch data
      const res = await fetch('/character');
      const data = await res.json();

      stopEllipsisAnimation();

      if (data.error) {
        descEl.textContent = "Error: " + data.error;
        spinner.style.display = "none";
        return;
      }

      descEl.textContent = data.character_description;

      // Wait for image to load
      imageElement.onload = () => {
        spinner.style.display = "none";
        imageElement.classList.remove("hidden");
      };

      imageElement.onerror = () => {
        spinner.style.display = "none";
        descEl.textContent = "Failed to load image.";
      };

      imageElement.src = data.image_url;

      // Re-trigger fade-in animation
      const imgContainer = document.getElementById("characterImage");
      imgContainer.classList.remove("fade-in");
      descEl.classList.remove("fade-in");
      void imgContainer.offsetWidth;  // force reflow
      void descEl.offsetWidth;
      imgContainer.classList.add("fade-in");
      descEl.classList.add("fade-in");
    }

    // âœ… Automatically run on first load
    fetchCharacter();
  </script>
</body>
</html>
